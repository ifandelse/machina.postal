/**
 * machina.postal - A plugin for machina.js that auto-wires finite state machines into the postal.js local message bus.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.4.0
 * Url: https://github.com/ifandelse/machina.postal
 * License(s): MIT
 */
(function(n,e){"object"==typeof module&&module.exports?module.exports=function(n,s){return e(n,s)}:"function"==typeof define&&define.amd?define(["machina","postal"],function(s,i){return e(s,i,n)}):e(n.machina,n.postal,n)})(this,function(n,e){n.Fsm.prototype.removeBusPublishing=function(){this.off("*",this._bus.channels[this._bus.eventChannel].eventPublisher)},n.Fsm.prototype.removeBusSubscriptions=function(){for(var n=this._bus.channels[this._bus.handlerChannel]._subscriptions;n.length;)n.pop().unsubscribe()},n.Fsm.prototype.removeAllBusIntegration=function(){this.removeBusSubscriptions(),this.removeBusPublishing()};var s=n.bus={config:{handlerChannelSuffix:"",eventChannelSuffix:".events"},wireHandlersToBus:function(n,e){n._bus.channels[e]._subscriptions.push(n._bus.channels[e].subscribe("#",function(e,s){n.handle.call(n,s.topic,e,s)}))},wireEventsToBus:function(n,e){var s=n._bus.channels[e].eventPublisher=function(){{var s=Array.prototype.slice.call(arguments,0);s[0].toLowerCase()}try{n._bus.channels[e].publish(s[0],s[1])}catch(i){console&&"undefined"!=typeof console.log&&console.log(i.toString())}};n.on("*",s)},wireUp:function(n){function s(s,i){return s&&_.isFunction(s.publish)&&_.isFunction(s.subscribe)?{name:s.channel,channel:s}:(_.isString(s)||(s=n.namespace+i),{name:s,channel:e.channel(s)})}if(!n._noBus){var i=s(n.handlerChannel,this.config.handlerChannelSuffix),t=s(n.eventChannel,this.config.eventChannelSuffix);n._bus={handlerChannel:i.name,eventChannel:t.name,channels:{}},n._bus.channels[i.name]=i.channel,n._bus.channels[t.name]=t.channel,n._bus.channels[i.name]._subscriptions=[],this.wireHandlersToBus(n,i.name),this.wireEventsToBus(n,t.name)}}};return n.on("newfsm",function(n){s.wireUp(n)}),n});